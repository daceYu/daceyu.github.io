<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Node.js + Web Socket 开源聊天室学习 | DaceYu_Space</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Node.js + Web Socket 开源聊天室学习</h1><a id="logo" href="/.">DaceYu_Space</a><p class="description">Coding....</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="https://github.com/daceYu"><i class="fa fa-rss"> GitHub</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Node.js + Web Socket 开源聊天室学习</h1><div class="post-meta">Jul 19, 2016<span> | </span><span class="category"><a href="/categories/前端开发/">前端开发</a><a href="/categories/前端开发/移动端/">移动端</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/07/19/node_chat/" href="/2016/07/19/node_chat/#comments" class="ds-thread-count"></a><div class="post-content"><h3 id="u58F0_u660E_3A_u672C_u6587_u662F_u57FA_u4E8E_u5B66_u4E60_u5F00_u6E90_u9879_u76EE_u7684_u7B14_u8BB0_u9884_u7559"><a href="#u58F0_u660E_3A_u672C_u6587_u662F_u57FA_u4E8E_u5B66_u4E60_u5F00_u6E90_u9879_u76EE_u7684_u7B14_u8BB0_u9884_u7559" class="headerlink" title="声明:本文是基于学习开源项目的笔记预留"></a>声明:本文是基于学习开源项目的笔记预留</h3><p>将使用Node.js加web socket协议打造一个网页即时聊天程序~<br>其中将会使用到express和socket.io两个包模块，下面会有介绍。<br><a id="more"></a></p>
<h2 id="u6E90_u7801_26amp_3B_u6F14_u793A"><a href="#u6E90_u7801_26amp_3B_u6F14_u793A" class="headerlink" title="源码&amp;演示"></a>源码&amp;演示</h2><p><a href="http://hichat.herokuapp.com/" target="_blank" rel="external">在线演示</a>(heroku服务器网速略慢且免费套餐是小水管，建议下载代码本地运行)<br>源码可访问项目的<a href="https://github.com/daceYu/chat" target="_blank" rel="external">GITHUB</a>页面下载<br>本地运行方法：</p>
<ul>
<li>命令行运行<code>npm install</code></li>
<li>模块下载成功后，运行<code>node server</code>启动服务器</li>
<li>打开浏览器访问<code>localhost</code></li>
</ul>
<p>下图为效果预览：<br><img src="http://images.cnitblog.com/i/431064/201403/312228045164946.jpg" alt=""></p>
<h2 id="u51C6_u5907_u5DE5_u4F5C"><a href="#u51C6_u5907_u5DE5_u4F5C" class="headerlink" title="准备工作"></a>准备工作</h2><p>本文示例环境为Windows，Linux也就Node的安装与命令行稍有区别，程序实现部分基本与平台无关。</p>
<h3 id="Node_u76F8_u5173"><a href="#Node_u76F8_u5173" class="headerlink" title="Node相关"></a>Node相关</h3><ul>
<li>你需要在本机安装Node.js（废话）</li>
<li>多少需要一点Node.js的基础知识，如果还未曾了解过Node.js，<a href="http://www.nodebeginner.org/index-zh-cn.html" target="_blank" rel="external">这里</a>有一篇不错的入门教程</li>
</ul>
<p>然后我们就可以开始创建一个简单的HTTP服务器啦。<br>类似下面非常简单的代码，它创建了一个HTTP服务器并监听系统的3000端口。<br>//node server example<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引入http模块</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>),</span><br><span class="line">    <span class="comment">//创建一个服务器</span></span><br><span class="line">    server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">            <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span></span><br><span class="line">        &#125;);</span><br><span class="line">        res.write(<span class="string">'hello world!'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">//监听3000端口</span></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'server started'</span>);</span><br></pre></td></tr></table></figure></p>
<p>将其保存为一个js文件比如<code>server.js</code>，然后从命令行运行<code>node server</code>或者<code>node server.js</code>，服务器便可启动了，此刻我们可以在浏览器地址栏输入<code>localhost</code>进行访问，也可以输入本机IP<code>127.0.0.1</code>，都不用加端口，因为我们服务器监听的是默认的3000端口。当然，如果你机子上面80端口被其他程序占用了，可以选择其他端口比如8080，这样访问的时候需要显示地加上端口号<code>localhost:3000</code>。<br><img src="http://images.cnitblog.com/blog/431064/201403/311618125943356.png" alt=""></p>
<h3 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h3><p>首先通过<code>npm</code>进行安装</p>
<ul>
<li>在我们的项目文件夹下打开命令行（tip: 按住Shift同时右击，可以在右键菜单中找到’从此处打开命令行’选项）</li>
<li>在命令行中输入<code>npm install express</code>回车进行安装</li>
<li>然后在<code>server.js</code>中通过<code>require(&#39;express&#39;)</code>将其引入到项目中进行使用</li>
</ul>
<p>express是node.js中管理路由响应请求的模块，根据请求的URL返回相应的HTML页面。这里我们使用一个事先写好的静态页面返回给客户端，只需使用express指定要返回的页面的路径即可。如果不用这个包，我们需要将HTML代码与后台JavaScript代码写在一起进行请求的响应，不太方便。<br>//返回一个简单的HTML内容<br><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server = <span class="transposed_variable">http.</span>createServer(<span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> &#123;</span></span><br><span class="line">    <span class="transposed_variable">res.</span>writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span> <span class="comment">//将返回类型由text/plain改为text/html</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="transposed_variable">res.</span>write(<span class="string">'&lt;h1&gt;hello world!&lt;/h1&gt;'</span>); <span class="comment">//返回HTML标签</span></span><br><span class="line">    <span class="transposed_variable">res.</span><span class="keyword">end</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在存放上一步创建的server.js文件的地方，我们新建一个文件夹名字为www用来存放我们的网页文件，包括图片以及前端的js文件等。假设已经在www文件夹下写好了一个index.html文件（将在下一步介绍，这一步你可以放一个空的HTML文件），则可以通过以下方式使用express将该页面返回到浏览器。可以看到较最开始，我们的服务器代码简洁了不少。<br>//使用express模块返回静态页面<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>), <span class="comment">//引入express模块</span></span><br><span class="line">    app = express(),</span><br><span class="line">    server = <span class="keyword">require</span>(<span class="string">'http'</span>).createServer(app);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/'</span>, express.<span class="keyword">static</span>(__dirname + <span class="string">'/www'</span>)); <span class="comment">//指定静态HTML文件的位置</span></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="http://images.cnitblog.com/blog/431064/201403/311618129385927.png" alt=""><br><strong>其中有四个按钮，分别是设置字体颜色，发送表情，发送图片和清除记录，将会在下面介绍其实现</strong></p>
<h3 id="socket-io"><a href="#socket-io" class="headerlink" title="socket.io"></a>socket.io</h3><p>Node.js中使用socket的一个包。使用它可以很方便地建立服务器到客户端的sockets连接，发送事件与接收特定事件。</p>
<p>同样通过npm进行安装<code>npm install socket.io</code>。安装后在node_modules文件夹下新生成了一个socket.io文件夹，其中我们可以找到一个socket.io.js文件。将它引入到HTML页面，这样我们就可以在前端使用socket.io与服务器进行通信了。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"/socket.io/socket.io.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>同时服务器端的server.js里跟使用express一样，也要通过<code>require(&#39;socket.io&#39;)</code>将其引入到项目中，这样就可以在服务器端使用socket.io了。</p>
<p>使用socket.io，其前后端句法是一致的，即通过<code>socket.emit()</code>来激发一个事件，通过<code>socket.on()</code>来侦听和处理对应事件。这两个事件通过传递的参数进行通信。具体工作模式可以看下面这个示例。</p>
<p>比如我们在index.html里面有如下JavaScript代码（假设你已经在页面放了一个ID为<code>sendBtn</code>的按钮）：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">	<span class="keyword">var</span> socket=io.connect(),<span class="comment">//与服务器进行连接</span></span><br><span class="line">		button=<span class="built_in">document</span>.getElementById(<span class="string">'sendBtn'</span>);</span><br><span class="line">	button.onclick=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		socket.emit(<span class="string">'foo'</span>, <span class="string">'hello'</span>);<span class="comment">//发送一个名为foo的事件，并且传递一个字符串数据‘hello’</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>述代码首先建立与服务器的连接，然后得到一个socket实例。之后如果页面上面一个ID为sendBtn的按钮被点击的话，我们就通过这个socket实例发起一个名为<code>foo</code>的事件，同时传递一个<code>hello</code>字符串信息到服务器。</p>
<p>与此同时，我们需要在服务器端写相应的代码来处理这个<code>foo</code>事件并接收传递来的数据。</p>
<p>为此，我们在<code>server.js</code>中可以这样写：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务器及页面响应部分</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>),</span><br><span class="line">    app = express(),</span><br><span class="line">    server = <span class="keyword">require</span>(<span class="string">'http'</span>).createServer(app),</span><br><span class="line">    io = <span class="keyword">require</span>(<span class="string">'socket.io'</span>).listen(server); <span class="comment">//引入socket.io模块并绑定到服务器</span></span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/'</span>, express.<span class="keyword">static</span>(__dirname + <span class="string">'/www'</span>));</span><br><span class="line">server.listen(<span class="number">80</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket部分</span></span><br><span class="line">io.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span><span class="params">(socket)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//接收并处理客户端发送的foo事件</span></span><br><span class="line">    socket.on(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span><span class="params">(data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//将消息输出到控制台</span></span><br><span class="line">        console.log(data);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p> 现在<code>Command+C</code>关闭之前启动的服务器，再次输入node server启动服务器运行新代码查看效果，一切正常的话你会在点击了页面的按扭后，在命令行窗口里看到输出的’hello’字符串。<br> 一如之前所说，socket.io在前后端的句法是一致的，所以相反地，从服务器发送事件到客户端，在客户端接收并处理消息也是显而易见的事件了。这里只是简单介绍，具体下面会通过发送聊天消息进一步介绍。</p>
<h2 id="u57FA_u672C_u9875_u9762"><a href="#u57FA_u672C_u9875_u9762" class="headerlink" title="基本页面"></a>基本页面</h2><p>有了上面一些基础的了解，下面可以进入聊天程序功能的开发了。</p>
<p>首先我们构建主页面。因为是比较大众化的应用了，界面不用多想，脑海中已经有大致的雏形，它有一个呈现消息的主窗体，还有一个输入消息的文本框，同时需要一个发送消息的按钮，这三个是必备的。</p>
<p>另外就是，这里还准备实现以下四个功能，所以界面上还有设置字体颜色，发送表情，发送图片和清除记录四个按钮。</p>
<p>最后的页面也就是先前截图展示的那们，而代码如下：</p>
<p>www/index.html<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">http-equiv</span>=<span class="value">"X-UA-Compatible"</span> <span class="attribute">content</span>=<span class="value">"IE=edge,chrome=1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"author"</span> <span class="attribute">content</span>=<span class="value">"Wayou"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"description"</span> <span class="attribute">content</span>=<span class="value">"hichat | a simple chat application built with node.js and websocket"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"viewport"</span> <span class="attribute">content</span>=<span class="value">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">title</span>&gt;</span>hichat<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">href</span>=<span class="value">"styles/main.css"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"shortcut icon"</span> <span class="attribute">href</span>=<span class="value">"favicon.ico"</span> <span class="attribute">type</span>=<span class="value">"image/x-icon"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"icon"</span> <span class="attribute">href</span>=<span class="value">"favicon.ico"</span> <span class="attribute">type</span>=<span class="value">"image/x-icon"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"wrapper"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"banner"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">h1</span>&gt;</span>HiChat :)<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">span</span> <span class="attribute">id</span>=<span class="value">"status"</span>&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"historyMsg"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"controls"</span> &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"items"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"colorStyle"</span> <span class="attribute">type</span>=<span class="value">"color"</span> <span class="attribute">placeHolder</span>=<span class="value">'#000'</span> <span class="attribute">title</span>=<span class="value">"font color"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"emoji"</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">value</span>=<span class="value">"emoji"</span> <span class="attribute">title</span>=<span class="value">"emoji"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"sendImage"</span> <span class="attribute">class</span>=<span class="value">"imageLable"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">value</span>=<span class="value">"image"</span>  /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"sendImage"</span> <span class="attribute">type</span>=<span class="value">"file"</span> <span class="attribute">value</span>=<span class="value">"image"</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"clearBtn"</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">value</span>=<span class="value">"clear"</span> <span class="attribute">title</span>=<span class="value">"clear screen"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">textarea</span> <span class="attribute">id</span>=<span class="value">"messageInput"</span> <span class="attribute">placeHolder</span>=<span class="value">"enter to send"</span>&gt;</span><span class="tag">&lt;/<span class="title">textarea</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"sendBtn"</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">value</span>=<span class="value">"SEND"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"emojiWrapper"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"loginWrapper"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">p</span> <span class="attribute">id</span>=<span class="value">"info"</span>&gt;</span>connecting to server...<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"nickWrapper"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">placeHolder</span>=<span class="value">"nickname"</span> <span class="attribute">id</span>=<span class="value">"nicknameInput"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">value</span>=<span class="value">"OK"</span> <span class="attribute">id</span>=<span class="value">"loginBtn"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"/socket.io/socket.io.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"scripts/hichat.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>样式文件 www/css/style.css<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">html</span>, <span class="tag">body</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">margin</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">background-color</span>:<span class="value"> <span class="hexcolor">#efefef</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">font-family</span>:<span class="value"> sans-serif</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.wrapper</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">500px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">640px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">padding</span>:<span class="value"> <span class="number">5px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">margin</span>:<span class="value"> <span class="number">0</span> auto</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">background-color</span>:<span class="value"> <span class="hexcolor">#ddd</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#loginWrapper</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">position</span>:<span class="value"> fixed</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">top</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">right</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">bottom</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">left</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">background-color</span>:<span class="value"> <span class="function">rgba</span>(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, .<span class="number">6</span>)</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">text-align</span>:<span class="value"> center</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">color</span>:<span class="value"> <span class="hexcolor">#fff</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">display</span>:<span class="value"> block</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">padding-top</span>:<span class="value"> <span class="number">200px</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#nickWrapper</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">display</span>:<span class="value"> none</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.banner</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">80px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">100%</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.banner</span> <span class="tag">p</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">float</span>:<span class="value"> left</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">display</span>:<span class="value"> inline-block</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.controls</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">100px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">margin</span>:<span class="value"> <span class="number">5px</span> <span class="number">0px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">position</span>:<span class="value"> relative</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#historyMsg</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">400px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">background-color</span>:<span class="value"> <span class="hexcolor">#fff</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">overflow</span>:<span class="value"> auto</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">padding</span>:<span class="value"> <span class="number">2px</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#historyMsg</span> <span class="tag">img</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">max-width</span>:<span class="value"> <span class="number">99%</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.timespan</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">color</span>:<span class="value"> <span class="hexcolor">#ddd</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.items</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">30px</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#colorStyle</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">50px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">border</span>:<span class="value"> none</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">padding</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="comment">/*custom the file input*/</span></span><br><span class="line"></span><br><span class="line"><span class="class">.imageLable</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">position</span>:<span class="value"> relative</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#sendImage</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">position</span>:<span class="value"> absolute</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">52px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">left</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">opacity</span>:<span class="value"> <span class="number">0</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">overflow</span>:<span class="value"> hidden</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="comment">/*end custom file input*/</span></span><br><span class="line"></span><br><span class="line"><span class="id">#messageInput</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">440px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">max-width</span>:<span class="value"> <span class="number">440px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">90px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">max-height</span>:<span class="value"> <span class="number">90px</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#sendBtn</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">50px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">96px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">float</span>:<span class="value"> right</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#emojiWrapper</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">display</span>:<span class="value"> none</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">500px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">bottom</span>:<span class="value"> <span class="number">105px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">position</span>:<span class="value"> absolute</span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">background-color</span>:<span class="value"> <span class="hexcolor">#aaa</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">box-shadow</span>:<span class="value"> <span class="number">0</span> <span class="number">0</span> <span class="number">10px</span> <span class="hexcolor">#555</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#emojiWrapper</span> <span class="tag">img</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">margin</span>:<span class="value"> <span class="number">2px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">padding</span>:<span class="value"> <span class="number">2px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">25px</span></span></span>;</span><br><span class="line">    <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">25px</span></span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="id">#emojiWrapper</span> <span class="tag">img</span><span class="pseudo">:hover</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">background-color</span>:<span class="value"> blue</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="class">.emoji</span><span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">display</span>:<span class="value"> inline</span></span>;</span><br><span class="line">&#125;</span></span><br><span class="line"><span class="tag">footer</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">text-align</span>:<span class="value"> center</span></span>;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>为了让项目有一个良好的目录结构便于管理，这里在www文件夹下又新建了一个styles文件夹存放样式文件main.css，然后新建一个scripts文件夹存放前端需要使用的js文件比如hichat.js（我们前端所有的js代码会放在这个文件中），而我们的服务器js文件server.js位置不变还是放在最外层。</p>
<p>同时再新建一个content文件夹用于存放其他资源比如图片等，其中content文件夹里再建一个emoji文件夹用于存入表情gif图，后面会用到。最后我们项目的目录结构应该是这样的了：</p>
<p>├─node_modules<br>└─www<br>    ├─content<br>    │  └─emoji<br>    ├─scripts<br>    └─css</p>
<p>此刻打开页面你看到的是一个淡黑色的遮罩层，而接下来我们要实现的是用户昵称的输入与服务器登入。这个遮罩层用于显示连接到服务器的状态信息，而当连接完成之后，会出现一个输入框用于昵称输入<br><img src="http://images.cnitblog.com/blog/431064/201403/311618142976143.png" alt=""></p>
<p>上面HTML代码里已经看到，我们将www/scripts/hichat.js文件已经引入到页面了，下面开始写一些基本的前端js开始实现连接功能。</p>
<p>定义一个全局变量用于我们整个程序的开发HiChat，同时使用<code>window.onload</code>在页面准备好之后实例化HiChat，调用其init方法运行我们的程序。</p>
<p>www/scripts/Hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//实例并初始化我们的hichat程序</span></span><br><span class="line">    <span class="keyword">var</span> hichat = <span class="keyword">new</span> HiChat();</span><br><span class="line">    hichat.init();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//定义我们的hichat类</span></span><br><span class="line"><span class="keyword">var</span> HiChat = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.socket = <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//向原型添加业务方法</span></span><br><span class="line">HiChat.prototype = &#123;</span><br><span class="line">    init: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="comment">//此方法初始化程序</span></span><br><span class="line">        <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">        <span class="comment">//建立到服务器的socket连接</span></span><br><span class="line">        <span class="keyword">this</span>.socket = io.connect();</span><br><span class="line">        <span class="comment">//监听socket的connect事件，此事件表示连接已经建立</span></span><br><span class="line">        <span class="keyword">this</span>.socket.on(<span class="string">'connect'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">//连接到服务器后，显示昵称输入框</span></span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">'info'</span>).textContent = <span class="string">'get yourself a nickname :)'</span>;</span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">'nickWrapper'</span>).style.display = <span class="string">'block'</span>;</span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">'nicknameInput'</span>).focus();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码定义了整个程序需要使用的类HiChat，之后我们处理消息显示消息等所有业务逻辑均写在这个类里面。<br>首先定义了一个程序的初始化方法，这里面初始化socket，监听连接事件，一旦连接到服务器，便显示昵称输入框。当用户输入昵称后，便可以在服务器后台接收到然后进行下一步的处理了。</p>
<p><img src="http://images.cnitblog.com/i/431064/201403/311708185008877.gif" alt=""></p>
<h2 id="u8BBE_u7F6E_u6635_u79F0"><a href="#u8BBE_u7F6E_u6635_u79F0" class="headerlink" title="设置昵称"></a>设置昵称</h2><p>我们要求连接的用户需要首先设置一个昵称，且这个昵称还要唯一，也就是不能与别人同名。一是方便用户区分，二是为了统计在线人数，同时也方便维护一个保存所有用户昵称的数组。</p>
<p>为此在后台server.js中，我们创建一个名叫users的全局数组变量，当一个用户设置好昵称发送到服务器的时候，将昵称压入users数组。同时注意，如果用户断线离开了，也要相应地从users数组中移除以保证数据的正确性。</p>
<p>在前台，输入昵称点击OK提交后，我们需要发起一个设置昵称的事件以便服务器侦听到。将以下代码添加到之前的<code>init</code>方法中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//昵称设置的确定按钮</span></span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'loginBtn'</span>).addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> nickName = <span class="built_in">document</span>.getElementById(<span class="string">'nicknameInput'</span>).value;</span><br><span class="line">    <span class="comment">//检查昵称输入框是否为空</span></span><br><span class="line">    <span class="keyword">if</span> (nickName.trim().length != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//不为空，则发起一个login事件并将输入的昵称发送到服务器</span></span><br><span class="line">        that.socket.emit(<span class="string">'login'</span>, nickName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//否则输入框获得焦点</span></span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'nicknameInput'</span>).focus();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>server.js<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务器及页面部分</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>),</span><br><span class="line">    app = express(),</span><br><span class="line">    server = <span class="keyword">require</span>(<span class="string">'http'</span>).createServer(app),</span><br><span class="line">    io = <span class="keyword">require</span>(<span class="string">'socket.io'</span>).listen(server),</span><br><span class="line">    users=[];<span class="comment">//保存所有在线用户的昵称</span></span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/'</span>, express.<span class="keyword">static</span>(__dirname + <span class="string">'/www'</span>));</span><br><span class="line">server.listen(<span class="number">80</span>);</span><br><span class="line"><span class="comment">//socket部分</span></span><br><span class="line">io.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span><span class="params">(socket)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//昵称设置</span></span><br><span class="line">    socket.on(<span class="string">'login'</span>, <span class="function"><span class="keyword">function</span><span class="params">(nickname)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (users.indexOf(nickname) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            socket.emit(<span class="string">'nickExisted'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            socket.userIndex = users.length;</span><br><span class="line">            socket.nickname = nickname;</span><br><span class="line">            users.push(nickname);</span><br><span class="line">            socket.emit(<span class="string">'loginSuccess'</span>);</span><br><span class="line">            io.sockets.emit(<span class="string">'system'</span>, nickname); <span class="comment">//向所有连接到服务器的客户端发送当前登陆用户的昵称 </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>需要解释一下的是，在connection事件的回调函数中，socket表示的是当前连接到服务器的那个客户端。所以代码<code>socket.emit(&#39;foo&#39;)</code>则只有自己收得到这个事件，而<code>socket.broadcast.emit(&#39;foo&#39;)</code>则表示向除自己外的所有人发送该事件，另外，上面代码中，io表示服务器整个socket连接，所以代码<code>io.sockets.emit(&#39;foo&#39;)</code>表示所有人都可以收到该事件。</p>
</blockquote>
<p>上面代码先判断接收到的昵称是否已经存在在users中，如果存在，则向自己发送一个nickExisted事件，在前端接收到这个事件后我们显示一条信息通知用户。<br>将下面代码添加到hichat.js的inti方法中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.socket.on(<span class="string">'nickExisted'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="built_in">document</span>.getElementById(<span class="string">'info'</span>).textContent = <span class="string">'!nickname is taken, choose another pls'</span>; <span class="comment">//显示昵称被占用的提示</span></span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>如果昵称没有被其他用户占用，则将这个昵称压入users数组，同时将其作为一个属性存到当前socket变量中，并且将这个用户在数组中的索引（因为是数组最后一个元素，所以索引就是数组的长度<code>users.length</code>）也作为属性保存到socket中，后面会用到。最后向自己发送一个loginSuccess事件，通知前端登陆成功，前端接收到这个成功消息后将灰色遮罩层移除显示聊天界面。</p>
<p>将下面代码添加到hichat.js的inti方法中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.socket.on(<span class="string">'loginSuccess'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="built_in">document</span>.title = <span class="string">'hichat | '</span> + <span class="built_in">document</span>.getElementById(<span class="string">'nicknameInput'</span>).value;</span><br><span class="line">     <span class="built_in">document</span>.getElementById(<span class="string">'loginWrapper'</span>).style.display = <span class="string">'none'</span>;<span class="comment">//隐藏遮罩层显聊天界面</span></span><br><span class="line">     <span class="built_in">document</span>.getElementById(<span class="string">'messageInput'</span>).focus();<span class="comment">//让消息输入框获得焦点</span></span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="u5728_u7EBF_u7EDF_u8BA1"><a href="#u5728_u7EBF_u7EDF_u8BA1" class="headerlink" title="在线统计"></a>在线统计</h2><p>这里实现显示在线用户数及在聊天主界面中以系统身份显示用户连接离开等信息。</p>
<p>上面server.js中除了<code>loginSuccess</code>事件，后面还有一句代码，通过<code>io.sockets.emit</code>向所有用户发送了一个<code>system</code>事件，传递了刚登入用户的昵称，所有人接收到这个事件后，会在聊天窗口显示一条系统消息’某某加入了聊天室’。同时考虑到在前端我们无法得知用户是进入还是离开，所以在这个system事件里我们多传递一个数据来表明用户是进入还是离开。</p>
<p>将server.js中login事件更改如下：</p>
<p>server.js<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">socket</span>.on(<span class="string">'login'</span>, function(nickname) &#123;</span><br><span class="line">     <span class="keyword">if</span> (users.indexOf(nickname) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">         <span class="keyword">socket</span>.emit(<span class="string">'nickExisted'</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">socket</span>.userIndex = users.<span class="keyword">length</span>;</span><br><span class="line">         <span class="keyword">socket</span>.nickname = nickname;</span><br><span class="line">         users.<span class="keyword">push</span>(nickname);</span><br><span class="line">         <span class="keyword">socket</span>.emit(<span class="string">'loginSuccess'</span>);</span><br><span class="line">         io.sockets.emit(<span class="string">'system'</span>, nickname, users.<span class="keyword">length</span>, <span class="string">'login'</span>);</span><br><span class="line">     &#125;;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>较之前，多传递了一个<code>login</code>字符串。<br>同时再添加一个用户离开的事件，这个可能通过socket.io自带的<code>disconnect</code>事件完成，当一个用户断开连接，<code>disconnect</code>事件就会触发。在这个事件中，做两件事情，一是将用户从users数组中删除，一是发送一个system事件通知所有人’某某离开了聊天室’。</p>
<p>将以下代码添加到server.js中<code>connection</code>的回调函数中。<br>server.js<br><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//断开连接的事件</span></span><br><span class="line"><span class="transposed_variable">socket.</span>on(<span class="string">'disconnect'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> &#123;</span></span><br><span class="line">    <span class="comment">//将断开连接的用户从users中删除</span></span><br><span class="line">    <span class="transposed_variable">users.</span>splice(<span class="transposed_variable">socket.</span>userIndex, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//通知除自己以外的所有人</span></span><br><span class="line">    <span class="transposed_variable">socket.</span><span class="transposed_variable">broadcast.</span>emit(<span class="string">'system'</span>, <span class="transposed_variable">socket.</span>nickname, <span class="transposed_variable">users.</span><span class="built_in">length</span>, <span class="string">'logout'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>上面代码通过JavaScript数组的splice方法将当前断开连接的用户从users数组中删除，这里我们看到之前保存的用户索引被使用了。同时发送和用户连接时一样的system事件通知所有人’某某离开了’，为了让前端知道是离开事件，所以发送了一个’logout’字符串。</p>
<p>下面开始前端的实现，也就是接收system事件。<br>在hichat.js中，将以下代码添加到init方法中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.socket.on(<span class="string">'system'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">nickName, userCount, type</span>) </span>&#123;</span><br><span class="line">     <span class="comment">//判断用户是连接还是离开以显示不同的信息</span></span><br><span class="line">     <span class="keyword">var</span> msg = nickName + (type == <span class="string">'login'</span> ? <span class="string">' joined'</span> : <span class="string">' left'</span>);</span><br><span class="line">     <span class="keyword">var</span> p = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>);</span><br><span class="line">     p.textContent = msg;</span><br><span class="line">     <span class="built_in">document</span>.getElementById(<span class="string">'historyMsg'</span>).appendChild(p);</span><br><span class="line">     <span class="comment">//将在线人数显示到页面顶部</span></span><br><span class="line">     <span class="built_in">document</span>.getElementById(<span class="string">'status'</span>).textContent = userCount + (userCount &gt; <span class="number">1</span> ? <span class="string">' users'</span> : <span class="string">' user'</span>) + <span class="string">' online'</span>;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>现在运行程序，打开多个浏览器标签，然后登陆离开，你就可以看到相应的系统提示消息了。</p>
<p><img src="http://images.cnitblog.com/blog/431064/201403/311618153607802.png" alt=""></p>
<h2 id="u53D1_u9001_u6D88_u606F"><a href="#u53D1_u9001_u6D88_u606F" class="headerlink" title="发送消息"></a>发送消息</h2><p>用户连接以及断开我们需要显示系统消息，用户还要频繁的发送聊天消息，所以可以考虑将消息显示到页面这个功能单独写一个函数方便我们调用。为此我们向HiChat类中添加一个<code>_displayNewMsg</code>的方法，它接收要显示的消息，消息来自谁，以及一个颜色共三个参数。因为我们想系统消息区别于普通用户的消息，所以增加一个颜色参数。同时这个参数也方便我们之后实现让用户自定义文本颜色做准备。</p>
<p>将以下代码添加到的我的HiChat类当中。<br>www/scripts/hichat.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向原型添加业务方法</span></span><br><span class="line">HiChat.prototype = &#123;</span><br><span class="line">    init: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">//此方法初始化程序</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    _displayNewMsg: <span class="function"><span class="keyword">function</span>(<span class="params">user, msg, color</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> container = <span class="built_in">document</span>.getElementById(<span class="string">'historyMsg'</span>),</span><br><span class="line">            msgToDisplay = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>),</span><br><span class="line">            date = <span class="keyword">new</span> <span class="built_in">Date</span>().toTimeString().substr(<span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line">        msgToDisplay.style.color = color || <span class="string">'#000'</span>;</span><br><span class="line">        msgToDisplay.innerHTML = user + <span class="string">'&lt;span class="timespan"&gt;('</span> + date + <span class="string">'): &lt;/span&gt;'</span> + msg;</span><br><span class="line">        container.appendChild(msgToDisplay);</span><br><span class="line">        container.scrollTop = container.scrollHeight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 在<code>_displayNewMsg</code>方法中，我们还向消息添加了一个日期。我们也判断了该方法在调用时有没有传递颜色参数，没有传递颜色的话默认使用<code>#000</code>即黑色。</p>
<p>同时修改我们在system事件中显示系统消息的代码，让它调用这个<code>_displayNewMsg</code>方法。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.socket.on(<span class="string">'system'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">nickName, userCount, type</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> msg = nickName + (type == <span class="string">'login'</span> ? <span class="string">' joined'</span> : <span class="string">' left'</span>);</span><br><span class="line">    <span class="comment">//指定系统消息显示为红色</span></span><br><span class="line">    that._displayNewMsg(<span class="string">'system '</span>, msg, <span class="string">'red'</span>);</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'status'</span>).textContent = userCount + (userCount &gt; <span class="number">1</span> ? <span class="string">' users'</span> : <span class="string">' user'</span>) + <span class="string">' online'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>现在的效果如下：<br><img src="http://images.cnitblog.com/blog/431064/201403/311618157197144.png" alt=""></p>
<p>有了这个显示消息的方法后，下面就开始实现用户之间的聊天功能了。</p>
<p>做法也很简单，如果你掌握了上面所描述的<code>emit</code>发送事件，<code>on</code>接收事件，那么用户聊天消息的发送接收也就轻车熟路了。</p>
<p>首先为页面的发送按钮写一个click事件处理程序，我们通过<code>addEventListner</code>来监听这个<code>click</code>事件，当用户点击发送的时候，先检查输入框是否为空，如果不为空，则向服务器发送<code>postMsg</code>事件，将用户输入的聊天文本发送到服务器，由服务器接收并分发到除自己外的所有用户。</p>
<p>将以下代码添加到hichat.js的<code>inti</code>方法中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'sendBtn'</span>).addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> messageInput = <span class="built_in">document</span>.getElementById(<span class="string">'messageInput'</span>),</span><br><span class="line">        msg = messageInput.value;</span><br><span class="line">    messageInput.value = <span class="string">''</span>;</span><br><span class="line">    messageInput.focus();</span><br><span class="line">    <span class="keyword">if</span> (msg.trim().length != <span class="number">0</span>) &#123;</span><br><span class="line">        that.socket.emit(<span class="string">'postMsg'</span>, msg); <span class="comment">//把消息发送到服务器</span></span><br><span class="line">        that._displayNewMsg(<span class="string">'me'</span>, msg); <span class="comment">//把自己的消息显示到自己的窗口中</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>在server.js中添加代码以接收<code>postMsg</code>事件。</p>
<p>server.js<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">io.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span><span class="params">(socket)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//其他代码。。。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收新消息</span></span><br><span class="line">    socket.on(<span class="string">'postMsg'</span>, <span class="function"><span class="keyword">function</span><span class="params">(msg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//将消息发送到除自己外的所有用户</span></span><br><span class="line">        socket.broadcast.emit(<span class="string">'newMsg'</span>, socket.nickname, msg);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>然后在客户端接收服务器发送的<code>newMsg</code>事件，并将聊天消息显示到页面。</p>
<p>将以下代码显示添加到hichat.js的<code>init</code>方法中了。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.socket.on(<span class="string">'newMsg'</span>, <span class="function"><span class="keyword">function</span><span class="params">(user, msg)</span> </span>&#123;</span><br><span class="line">    that._displayNewMsg(user, msg);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>运行程序，现在可以发送聊天消息了。<br><img src="http://images.cnitblog.com/blog/431064/201403/311618161109431.png" alt=""></p>
<h2 id="u53D1_u9001_u56FE_u7247"><a href="#u53D1_u9001_u56FE_u7247" class="headerlink" title="发送图片"></a>发送图片</h2><p>上面已经实现了基本的聊天功能了，进一步，如果我们还想让用户可以发送图片，那程序便更加完美了。</p>
<p>图片不同于文字，但通过将图片转化为字符串形式后，便可以像发送普通文本消息一样发送图片了，只是在显示的时候将它还原为图片。</p>
<p>在这之前，我们已经将图片按钮在页面放好了，其实是一个文件类型的input，下面只需在它身上做功夫便可。</p>
<p>用户点击图片按钮后，弹出文件选择窗口供用户选择图片。之后我们可以在JavaScript代码中使用FileReader来将图片读取为base64格式的字符串形式进行发送。而base64格式的图片直接可以指定为图片的<code>src</code>，这样就可以将图片用<code>img标签</code>显示在页面了。</p>
<p>为此我们监听图片按钮的change事件，一但用户选择了图片，便显示到自己的屏幕上同时读取为文本发送到服务器。</p>
<p>将以下代码添加到hichat.js的<code>init</code>方法中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'sendImage'</span>).addEventListener(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//检查是否有文件被选中</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.files.length != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//获取文件并用FileReader进行读取</span></span><br><span class="line">         <span class="keyword">var</span> file = <span class="keyword">this</span>.files[<span class="number">0</span>],</span><br><span class="line">             reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">         <span class="keyword">if</span> (!reader) &#123;</span><br><span class="line">             that._displayNewMsg(<span class="string">'system'</span>, <span class="string">'!your browser doesn\'t support fileReader'</span>, <span class="string">'red'</span>);</span><br><span class="line">             <span class="keyword">this</span>.value = <span class="string">''</span>;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;;</span><br><span class="line">         reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//读取成功，显示到页面并发送到服务器</span></span><br><span class="line">             <span class="keyword">this</span>.value = <span class="string">''</span>;</span><br><span class="line">             that.socket.emit(<span class="string">'img'</span>, e.target.result);</span><br><span class="line">             that._displayImage(<span class="string">'me'</span>, e.target.result);</span><br><span class="line">         &#125;;</span><br><span class="line">         reader.readAsDataURL(file);</span><br><span class="line">     &#125;;</span><br><span class="line"> &#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>上面图片读取成功后，调用<code>_displayNImage</code>方法将图片显示在自己的屏幕同时向服务器发送了一个img事件，在server.js中，我们通过这个事件来接收并分发图片到每个用户。同时也意味着我们还要在前端写相应的代码来接收。</p>
<p>这个<code>_displayNImage</code>还没有实现，将会在下面介绍。</p>
<p>将以下代码添加到server.js的socket回调函数中。</p>
<p>server.js<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//接收用户发来的图片</span></span><br><span class="line"> socket.on(<span class="string">'img'</span>, <span class="function"><span class="keyword">function</span><span class="params">(imgData)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//通过一个newImg事件分发到除自己外的每个用户</span></span><br><span class="line">     socket.broadcast.emit(<span class="string">'newImg'</span>, socket.nickname, imgData);</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>同时向hichat.js的init方法添加以下代码以接收显示图片。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.socket.on(<span class="string">'newImg'</span>, <span class="function"><span class="keyword">function</span><span class="params">(user, img)</span> </span>&#123;</span><br><span class="line">    that._displayImage(user, img);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>有个问题就是如果图片过大，会破坏整个窗口的布局，或者会出现水平滚动条，所以我们对图片进行样式上的设置让它最多只能以聊天窗口的99%宽度来显示，这样过大的图片就会自己缩小了。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="id">#historyMsg</span> <span class="tag">img</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">max-width</span>:<span class="value"> <span class="number">99%</span></span></span>;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>但考虑到缩小后的图片有可能失真，用户看不清，我们需要提供一个方法让用户可以查看原尺寸大小的图片，所以将图片用一个链接进行包裹，当点击图片的时候我们打开一个新的窗口页面，并将图片按原始大小呈现到这个新页面中让用户查看。</p>
<p>所以最后我们实现的<code>_displayNImage</code>方法应该是这样的。</p>
<p>将以下代码添加到hichat.js的HiChat类中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_displayImage: function(user, imgData, <span class="keyword">color</span>) &#123;</span><br><span class="line">    var <span class="keyword">container</span> = document.getElementById(<span class="string">'historyMsg'</span>),</span><br><span class="line">        msgToDisplay = document.createElement(<span class="string">'p'</span>),</span><br><span class="line">        <span class="keyword">date</span> = new Date().toTimeString().substr(<span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line">    msgToDisplay.style.<span class="keyword">color</span> = <span class="keyword">color</span> || <span class="string">'#000'</span>;</span><br><span class="line">    msgToDisplay.innerHTML = user + <span class="string">'&lt;span class="timespan"&gt;('</span> + <span class="keyword">date</span> + <span class="string">'): &lt;/span&gt; &lt;br/&gt;'</span> + <span class="string">'&lt;a href="'</span> + imgData + <span class="string">'" target="_blank"&gt;&lt;img src="'</span> + imgData + <span class="string">'"/&gt;&lt;/a&gt;'</span>;</span><br><span class="line">    <span class="keyword">container</span>.appendChild(msgToDisplay);</span><br><span class="line">    <span class="keyword">container</span>.scrollTop = <span class="keyword">container</span>.scrollHeight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再次启动服务器打开程序，我们可以发送图片了。<br><img src="http://images.cnitblog.com/blog/431064/201403/311618166885073.png" alt=""></p>
<h2 id="u53D1_u9001_u8868_u60C5"><a href="#u53D1_u9001_u8868_u60C5" class="headerlink" title="发送表情"></a>发送表情</h2><p>文字总是很难表达出说话时的面部表情的，于是表情就诞生了。</p>
<p>前面已经介绍过如何发送图片了，严格来说，表情也是图片，但它有特殊之处，因为表情可以穿插在文字中一并发送，所以就不能像处理图片那样来处理表情了。</p>
<p>根据以往的经验，其他聊天程序是把表情转为符号，比如我想发笑脸，并且规定’:)’这个符号代码笑脸表情，然后数据传输过程中其实转输的是一个冒号加右括号的组合，当每个客户端接收到消息后，从文字当中将这些表情符号提取出来，再用gif图片替换，这样呈现到页面我们就 看到了表情加文字的混排了。</p>
<blockquote>
<p>你好,王尼玛[emoji:23]</p>
</blockquote>
<p>上面形象地展示了我们程序中表情的使用，可以看出我规定了一种格式来代表表情，[emoji:xx]，中括号括起来然后’emoji’加个冒号，后面跟一个数字，这个数字表示某个gif图片的编号。程序中，如果我们点击表情按扭，然后呈现所有可用的表情图片，当用户选择一个表情后，生成对应的代码插入到当前待发送的文字消息中。发出去后，每个人接收到的也是代码形式的消息，只是在将消息显示到页面前，我们将表情代码提取出来，获取图片编号，然后用相应的图片替换。</p>
<p>首先得将所有可用的表情图片显示到一个小窗口，这个窗口会在点击了表情按钮后显示如下图，在HTML代码中已经添加好了这个窗口了，下面只需实现代码部分。<br><img src="http://images.cnitblog.com/i/431064/201403/311709554698335.gif" alt=""></p>
<p>我们使用兔斯基作为我们聊天程序的表情包。可以看到，有很多张gif图，如果手动编写的话，要花一些功夫，不断地写<code>&lt;img src=&#39;xx.gif&#39;/&gt;</code>，所以考虑将这个工作交给代码来自动完成，写一个方法来初始化所有表情。</p>
<p>为此将以下代码添加到<code>HiChat</code>类中，并在<code>init</code>方法中调用这个方法。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_initialEmoji: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> emojiContainer = <span class="built_in">document</span>.getElementById(<span class="string">'emojiWrapper'</span>),</span><br><span class="line">        docFragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">69</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">var</span> emojiItem = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">        emojiItem.src = <span class="string">'../content/emoji/'</span> + i + <span class="string">'.gif'</span>;</span><br><span class="line">        emojiItem.title = i;</span><br><span class="line">        docFragment.appendChild(emojiItem);</span><br><span class="line">    &#125;;</span><br><span class="line">    emojiContainer.appendChild(docFragment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时将以下代码添加到hichat.js的<code>init</code>方法中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>._initialEmoji();</span><br><span class="line"> <span class="built_in">document</span>.getElementById(<span class="string">'emoji'</span>).addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> emojiwrapper = <span class="built_in">document</span>.getElementById(<span class="string">'emojiWrapper'</span>);</span><br><span class="line">     emojiwrapper.style.display = <span class="string">'block'</span>;</span><br><span class="line">     e.stopPropagation();</span><br><span class="line"> &#125;, <span class="literal">false</span>);</span><br><span class="line"> <span class="built_in">document</span>.body.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> emojiwrapper = <span class="built_in">document</span>.getElementById(<span class="string">'emojiWrapper'</span>);</span><br><span class="line">     <span class="keyword">if</span> (e.target != emojiwrapper) &#123;</span><br><span class="line">         emojiwrapper.style.display = <span class="string">'none'</span>;</span><br><span class="line">     &#125;;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>上面向页面添加了两个单击事件，一是表情按钮单击显示表情窗口，二是点击页面其他地方关闭表情窗口。</p>
<p>现在要做的就是，具体到某个表情被选中后，需要获取被选中的表情，然后转换为相应的表情代码插入到消息框中。</p>
<p>为此我们再写一个这些图片的<code>click</code>事件处理程序。将以下代码添加到hichat.js的<code>inti</code>方法中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'emojiWrapper'</span>).addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//获取被点击的表情</span></span><br><span class="line">    <span class="keyword">var</span> target = e.target;</span><br><span class="line">    <span class="keyword">if</span> (target.nodeName.toLowerCase() == <span class="string">'img'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> messageInput = <span class="built_in">document</span>.getElementById(<span class="string">'messageInput'</span>);</span><br><span class="line">        messageInput.focus();</span><br><span class="line">        messageInput.value = messageInput.value + <span class="string">'[emoji:'</span> + target.title + <span class="string">']'</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>现在表情选中后，消息输入框中可以得到相应的代码了。<br><img src="http://images.cnitblog.com/blog/431064/201403/311618182196574.png" alt=""></p>
<p>之后的发送也普通消息发送没区别，因为之前已经实现了文本消息的发送了，所以这里不用再实现什么，只是需要更改一下之前我们用来显示消息的代码，首先判断消息文本中是否含有表情符号，如果有，则转换为图片，最后再显示到页面。</p>
<p>为此我们写一个方法接收文本消息为参数，用正则搜索其中的表情符号，将其替换为img标签，最后返回处理好的文本消息。</p>
<p>将以下代码添加到HiChat类中。</p>
<p>www/scripts/hichat.js<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">_showEmoji: function(msg) &#123;</span><br><span class="line">    <span class="keyword">var</span> match, <span class="literal">result</span> = msg,</span><br><span class="line">        reg = /\[emoji:\d+\]/g,</span><br><span class="line">        emojiIndex,</span><br><span class="line">        totalEmojiNum = document.getElementById('emojiWrapper').children.length;</span><br><span class="line">    <span class="keyword">while</span> (match = reg.exec(msg)) &#123;</span><br><span class="line">        emojiIndex = match[<span class="number">0</span>].slice(<span class="number">7</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (emojiIndex &gt; totalEmojiNum) &#123;</span><br><span class="line">            <span class="literal">result</span> = <span class="literal">result</span>.replace(match[<span class="number">0</span>], '[X]');</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">result</span> = <span class="literal">result</span>.replace(match[<span class="number">0</span>], '&lt;img class=<span class="string">"emoji"</span> src=<span class="string">"../content/emoji/' + emojiIndex + '.gif"</span> /&gt;');</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在去修改之前我们显示消息的<code>_displayNewMsg</code>方法，让它在显示消息之前调用这个<code>_showEmoji</code>方法。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_displayNewMsg: <span class="function"><span class="keyword">function</span>(<span class="params">user, msg, color</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> container = <span class="built_in">document</span>.getElementById(<span class="string">'historyMsg'</span>),</span><br><span class="line">         msgToDisplay = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>),</span><br><span class="line">         date = <span class="keyword">new</span> <span class="built_in">Date</span>().toTimeString().substr(<span class="number">0</span>, <span class="number">8</span>),</span><br><span class="line">         <span class="comment">//将消息中的表情转换为图片</span></span><br><span class="line">         msg = <span class="keyword">this</span>._showEmoji(msg);</span><br><span class="line">     msgToDisplay.style.color = color || <span class="string">'#000'</span>;</span><br><span class="line">     msgToDisplay.innerHTML = user + <span class="string">'&lt;span class="timespan"&gt;('</span> + date + <span class="string">'): &lt;/span&gt;'</span> + msg;</span><br><span class="line">     container.appendChild(msgToDisplay);</span><br><span class="line">     container.scrollTop = container.scrollHeight;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>下面是实现后的效果：<br><img src="http://images.cnitblog.com/blog/431064/201403/311618187976918.png" alt=""></p>
<p>主要功能已经完成得差不多了，为了让程序更加人性与美观，可以加入一个修改文字颜色的功能，以及键盘快捷键操作的支持，这也是一般聊天程序都有的功能，回车即可以发送消息。</p>
<h2 id="u6587_u5B57_u989C_u8272"><a href="#u6587_u5B57_u989C_u8272" class="headerlink" title="文字颜色"></a>文字颜色</h2><p>万幸，HTML5新增了一个专门用于颜色选取的input标签，并且Chrome对它的支持非常之赞，直接弹出系统的颜色拾取窗口。<br><img src="http://images.cnitblog.com/blog/431064/201403/311618192035976.png" alt=""></p>
<p>IE及FF中均是一个普通的文本框，不过不影响使用，只是用户只能通过输入具体的颜色值来进行颜色设置，没有Chrome里面那么方便也直观。</p>
<p>之前我们的<code>_displayNewMsg</code>方法可以接收一个color参数，现在要做的就是每次发送消息到服务器的时候，多加一个color参数就可以了，同时，在显示消息时调用<code>_displayNewMsg</code>的时候将这个color传递过去。</p>
<p>下面是修改hichat.js中消息发送按钮代码的示例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'sendBtn'</span>).addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> messageInput = <span class="built_in">document</span>.getElementById(<span class="string">'messageInput'</span>),</span><br><span class="line">        msg = messageInput.value,</span><br><span class="line">        <span class="comment">//获取颜色值</span></span><br><span class="line">        color = <span class="built_in">document</span>.getElementById(<span class="string">'colorStyle'</span>).value;</span><br><span class="line">    messageInput.value = <span class="string">''</span>;</span><br><span class="line">    messageInput.focus();</span><br><span class="line">    <span class="keyword">if</span> (msg.trim().length != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//显示和发送时带上颜色值参数</span></span><br><span class="line">        that.socket.emit(<span class="string">'postMsg'</span>, msg, color);</span><br><span class="line">        that._displayNewMsg(<span class="string">'me'</span>, msg, color);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>同时修改hichat.js中接收消息的代码，让它接收颜色值<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.socket.on(<span class="string">'newMsg'</span>, <span class="function"><span class="keyword">function</span><span class="params">(user, msg, color)</span> </span>&#123;</span><br><span class="line">     that._displayNewMsg(user, msg, color);</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>这只是展示了发送按钮的修改，改动非常小，只是每次消息发送时获取一下颜色值，同时emit事件到服务器的时候也带上这个颜色值，这样前端在显示时就可以根据这个颜色值为每个不两只用户显示他们自己设置的颜色了。剩下的就是按相同的做法把发送图片时也加上颜色，这里省略。</p>
<p>最后效果：<br><img src="http://images.cnitblog.com/blog/431064/201403/311618196417575.png" alt=""></p>
<h3 id="u6309_u952E_u64CD_u4F5C"><a href="#u6309_u952E_u64CD_u4F5C" class="headerlink" title="按键操作"></a>按键操作</h3><p>将以下代码添加到hichat.js的inti方法中，这样在输入昵称后，按回车键就可以登陆，进入聊天界面后，回车键可以发送消息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'nicknameInput'</span>).addEventListener(<span class="string">'keyup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (e.keyCode == <span class="number">13</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> nickName = <span class="built_in">document</span>.getElementById(<span class="string">'nicknameInput'</span>).value;</span><br><span class="line">          <span class="keyword">if</span> (nickName.trim().length != <span class="number">0</span>) &#123;</span><br><span class="line">              that.socket.emit(<span class="string">'login'</span>, nickName);</span><br><span class="line">          &#125;;</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'messageInput'</span>).addEventListener(<span class="string">'keyup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> messageInput = <span class="built_in">document</span>.getElementById(<span class="string">'messageInput'</span>),</span><br><span class="line">          msg = messageInput.value,</span><br><span class="line">          color = <span class="built_in">document</span>.getElementById(<span class="string">'colorStyle'</span>).value;</span><br><span class="line">      <span class="keyword">if</span> (e.keyCode == <span class="number">13</span> &amp;&amp; msg.trim().length != <span class="number">0</span>) &#123;</span><br><span class="line">          messageInput.value = <span class="string">''</span>;</span><br><span class="line">          that.socket.emit(<span class="string">'postMsg'</span>, msg, color);</span><br><span class="line">          that._displayNewMsg(<span class="string">'me'</span>, msg, color);</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<h3 id="u90E8_u7F72_u4E0A_u7EBF"><a href="#u90E8_u7F72_u4E0A_u7EBF" class="headerlink" title="部署上线"></a>部署上线</h3><p>最后一步，当然就是将我们的辛勤结晶部署到实际的站点。这应该是最激动人心也是如释重负的一刻。但在这之前，让我们先添加一个node.js程序通用的package.json文件，该文件里面可以指定我们的程序使用了哪些模块，这样别人在获取到代码后，只需通过<code>npm install</code>命令就可以自己下载安装程序中需要的模块了，而不用我们把模块随源码一起发布。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://daceyu.com/2016/07/19/node_chat/" data-id="ciz99dkv0001q89tr5xgqq1p6" class="article-share-link">分享到</a><div class="tags"><a href="/tags/node-js/">node.js</a><a href="/tags/自用笔记/">自用笔记</a></div><div class="post-nav"><a href="/2016/09/01/iscroll.js回弹bug/" class="pre">解决iscroll.js上拉下拉刷新手指划出屏幕页面无法回弹问题</a><a href="/2016/07/12/grunt/" class="next">Grunt集成自启动工具</a></div><div data-thread-key="2016/07/19/node_chat/" data-title="Node.js + Web Socket 开源聊天室学习" data-url="http://daceyu.com/2016/07/19/node_chat/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/07/19/node_chat/" data-title="Node.js + Web Socket 开源聊天室学习" data-url="http://daceyu.com/2016/07/19/node_chat/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://daceyu.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CSS3/">CSS3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/">前端开发</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/移动端/">移动端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/移动端/框架/">框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端开发/移动端/用户体验/">用户体验</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信/">微信</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术无界/">技术无界</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/node-js/" style="font-size: 15px;">node.js</a> <a href="/tags/自用笔记/" style="font-size: 15px;">自用笔记</a> <a href="/tags/jqueryMobile/" style="font-size: 15px;">jqueryMobile</a> <a href="/tags/正则表达/" style="font-size: 15px;">正则表达</a> <a href="/tags/PS/" style="font-size: 15px;">PS</a> <a href="/tags/zepto/" style="font-size: 15px;">zepto</a> <a href="/tags/bootstrap/" style="font-size: 15px;">bootstrap</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/grunt/" style="font-size: 15px;">grunt</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/CSS-HACK/" style="font-size: 15px;">CSS HACK</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/11/06/wx/">微信开发－微信JS-SDK扫一扫功能</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/08/图片预览上传/">图片预览上传</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/01/iscroll.js回弹bug/">解决iscroll.js上拉下拉刷新手指划出屏幕页面无法回弹问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/19/node_chat/">Node.js + Web Socket 开源聊天室学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/12/grunt/">Grunt集成自启动工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/11/node+express/">node+express学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/07/微信脚本/">定时器发送微信信息</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/30/linear-gradient/">CSS3 线性渐变（linear-gradient）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/23/zepto&&jQuery/">jQuery Mobile还是Zepto?</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/20/zepto/">关于zepto</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://huangbingbing.com" title="ahBing" target="_blank">ahBing</a><ul></ul><a href="http://liyi.it" title="liyi" target="_blank">liyi</a><ul></ul><a href="http://makaiqian.com" title="maZu" target="_blank">maZu</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">DaceYu_Space.</a> created by<a rel="nofollow" target="_blank" href="https://daceyu.com"> Daceyu.</a> copy @ 2015 - 2016</div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'daceyu'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>